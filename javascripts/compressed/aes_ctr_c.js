/*Copyright (c) 2009 pidder <www.pidder.com>*/
/*(c) Chris Veness 2005-2008*/
if(typeof(pidCrypt)!="undefined"&&typeof(pidCrypt.AES)!="undefined"){pidCrypt.AES.CTR=function(){this.pidcrypt=new pidCrypt();this.aes=new pidCrypt.AES(this.pidcrypt);this.getOutput=function(){return this.pidcrypt.getOutput()};this.getAllMessages=function(a){return this.pidcrypt.getAllMessages(a)};this.isError=function(){return this.pidcrypt.isError()}};pidCrypt.AES.CTR.prototype.init=function(b,a){if(!a){a={}}if(!b){this.pidcrypt.appendError("pidCrypt.AES.CTR.initFromEncryption: Sorry, can not crypt or decrypt without password.\n")}this.pidcrypt.setDefaults();var d=this.pidcrypt.getParams();for(var c in a){d[c]=a[c]}d.password=b;d.key=b;d.dataOut="";this.pidcrypt.setParams(d);this.aes.init()};pidCrypt.AES.CTR.prototype.initEncrypt=function(c,b,a){this.init(b,a);this.pidcrypt.setParams({dataIn:c,encryptIn:c.toByteArray()})};pidCrypt.AES.CTR.prototype.initDecrypt=function(e,b,a){var f={};this.init(b,a);f.dataIn=e;var d=e.decodeBase64();var c=d.substr(0,8);f.salt=c.convertToHex();d=d.substr(8);f.decryptIn=d.toByteArray();this.pidcrypt.setParams(f)};pidCrypt.AES.CTR.prototype.getAllMessages=function(a){return this.pidcrypt.getAllMessages(a)};pidCrypt.AES.CTR.prototype.getCounterBlock=function(c){var b=new Array(c);var f=(new Date()).getTime();var e=Math.floor(f/1000);var a=f%1000;for(var d=0;d<4;d++){b[d]=(e>>>d*8)&255}for(d=0;d<4;d++){b[d+4]=a&255}return b.slice()};pidCrypt.AES.CTR.prototype.encryptRaw=function(k){var n=this.aes;var a=this.pidcrypt;var o=a.getParams();if(!k){k=o.encryptIn}a.setParams({encryptIn:k});var d=o.key;var h=Math.floor(o.nBits/8);var f=new Array(h);for(var s=0;s<h;s++){f[s]=isNaN(d.charCodeAt(s))?0:d.charCodeAt(s)}var x=n.encrypt(f.slice(0,16),n.expandKey(f));x=x.concat(x.slice(0,h-16));var e=this.getCounterBlock(o.blockSize);var l=byteArray2String(e.slice(0,8));a.setParams({salt:l.convertToHex()});var u=n.expandKey(x);var r=Math.ceil(k.length/o.blockSize);var j=new Array(r);for(var v=0;v<r;v++){for(var t=0;t<4;t++){e[15-t]=(v>>>t*8)&255}for(var t=0;t<4;t++){e[15-t-4]=(v/4294967296>>>t*8)}var g=n.encrypt(e,u);var q=v<r-1?o.blockSize:(k.length-1)%o.blockSize+1;var m=new Array(q);for(var s=0;s<q;s++){m[s]=g[s]^k[v*o.blockSize+s];m[s]=String.fromCharCode(m[s])}j[v]=m.join("")}var w=l+j.join("");a.setParams({dataOut:w,encryptOut:w});if(!a.isDebug()&&a.clear){a.clearParams()}return w};pidCrypt.AES.CTR.prototype.encrypt=function(b){var d=this.pidcrypt;var c=d.getParams();if(!b){b=c.dataIn}if(c.UTF8){b=b.encodeUTF8();d.setParams({key:d.getParam("key").encodeUTF8()})}d.setParams({dataIn:b,encryptIn:b.toByteArray()});var a=this.encryptRaw();a=a.encodeBase64();d.setParams({dataOut:a});if(!d.isDebug()&&d.clear){d.clearParams()}return a};pidCrypt.AES.CTR.prototype.encryptText=function(c,b,a){this.initEncrypt(c,b,a);return this.encrypt()};pidCrypt.AES.CTR.prototype.decryptRaw=function(m){var d=this.pidcrypt;var o=this.aes;var q=d.getParams();if(!m){m=q.decryptIn}d.setParams({decryptIn:m});if(!q.dataIn){d.setParams({dataIn:m})}var l=Math.floor(q.nBits/8);var h=new Array(l);for(var r=0;r<l;r++){h[r]=isNaN(q.key.charCodeAt(r))?0:q.key.charCodeAt(r)}var w=o.encrypt(h.slice(0,16),o.expandKey(h));w=w.concat(w.slice(0,l-16));var f=new Array(8);var n=q.salt.convertFromHex();for(r=0;r<8;r++){f[r]=n.charCodeAt(r)}var u=o.expandKey(w);var g=Math.ceil((m.length)/q.blockSize);var s=new Array(g);for(var v=0;v<g;v++){s[v]=m.slice(v*q.blockSize,v*q.blockSize+q.blockSize)}var a=new Array(s.length);var k=[];var e=[];for(v=0;v<g;v++){for(var t=0;t<4;t++){f[15-t]=((v)>>>t*8)&255}for(t=0;t<4;t++){f[15-t-4]=(((v+1)/4294967296-1)>>>t*8)&255}k=o.encrypt(f,u);e=new Array(s[v].length);for(r=0;r<s[v].length;r++){e[r]=k[r]^s[v][r];e[r]=String.fromCharCode(e[r])}a[v]=e.join("")}var j=a.join("");d.setParams({dataOut:j});if(!d.isDebug()&&d.clear){d.clearParams()}return j};pidCrypt.AES.CTR.prototype.decrypt=function(b){var d=this.pidcrypt;var c=d.getParams();if(b){d.setParams({dataIn:b,decryptIn:b.toByteArray()})}if(c.UTF8){d.setParams({key:d.getParam("key").encodeUTF8()})}var a=this.decryptRaw();a=a.decodeUTF8();d.setParams({dataOut:a});if(!d.isDebug()&&d.clear){d.clearParams()}return a};pidCrypt.AES.CTR.prototype.decryptText=function(c,b,a){this.initDecrypt(c,b,a);return this.decrypt()}};