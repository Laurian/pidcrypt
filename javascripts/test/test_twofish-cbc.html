<HTML>
<HEAD>
<SCRIPT src="../pidcrypt.js"></SCRIPT>
<SCRIPT src="../pidcrypt_util.js"></SCRIPT>
<SCRIPT src="../md5.js"></SCRIPT><!--needed for key and iv generation-->
<SCRIPT src="../cbc.js"></SCRIPT><!--needed for key and iv generation-->
<SCRIPT src="../twofish.js"></SCRIPT><!--needed block en-/decryption-->
<SCRIPT src="../twofish_cbc.js"></SCRIPT><!--needed for cbc mode-->
<SCRIPT>

function passed(testFunction){
  var span = document.getElementById(testFunction);
  span.innerHTML = 'passed'
  span.style.color = '#00C000';
}


function compute(testFunction){
  var password = 'password';
  var plain = 'Text to encrypt.';
  var bits = 256;
  var twofish = new pidCrypt.Twofish.CBC();
  var crypted ='';
  var cryptedRaw = '';
  var key = '8f66bc54ec5f9988f662cb75284eaa4e64879467ca852b94376a9ab54eae85ba';
  var  iv = 'eb5eb5ac35caf38dfc0ffcf50c1fb61e';
  var result ='';
  var options = {nBits:bits};
  var ok = false;
  switch(testFunction) {
    case 'init':
        twofish.init(password, options);
        crypted = twofish.encrypt(plain);
        twofish.init(password, options);
        result = twofish.decrypt();
        ok = (plain == result);
      break;
    case 'initDecrypt':
        twofish.initDecrypt(crypted, password, options);
        result = twofish.decrypt();
        ok = (plain == result);
      break;
    case 'initEncrypt':
        twofish.initEncrypt(plain, password, options);
        crypted = twofish.encrypt();
        twofish.initDecrypt(crypted, password, options);
        result = twofish.decrypt();
        ok = (plain == result);
      break;
    case 'initByValues':
        twofish.initByValues(plain, key, iv);
        crypted = twofish.encrypt();
        twofish.initByValues(crypted, key, iv);
        result = twofish.decrypt();
        ok = (plain == result);
      break;
    case 'knownAnswer':
        key = '00000000000000000000000000000000';
//        key = '000000000000000000000000000000000000000000000000';
//        key = '0000000000000000000000000000000000000000000000000000000000000000';
        iv = '00000000000000000000000000000000';
        plain = '00000000000000000000000000000000';
//        key = '3CC3B181E1495D0495D652B66921DA0F';
        iv = '3CC3B181E1495D0495D652B66921DA0F';
        plain = 'BE938D30FAB43B71F2E114E9C0529299';
        /*
        //256 bit
        key = 'D0A260EB41755B19374BABF259A79DB3EA7162E65490B03B1AE4871FB35EF23B';
        iv = 'EA7162E65490B03B1AE4871FB35EF23B';
        plain = 'D0A260EB41755B19374BABF259A79DB3';
        */
        var lastCrypted;
        var CV0;
        var out = '';
        for(var i=0;i<1;i++)
        {
          out += 'I='+ i + '<BR>';
          out += 'KEY=' + key + '<BR>';
          out +=  'IV=' + iv + '<BR>';
          out +=  'PT=' + plain + '<BR>';
          for(var j=0;j<1;j++)
          {
            twofish.initByValues(null, key, iv , {encryptIn:plain.convertFromHex().toByteArray(), noPadding:true, nBits:128});
            crypted = twofish.decryptRaw();
            if(j==0)
              plain = iv;
            else
              plain = lastCrypted;
            iv = crypted.convertToHex();
            lastCrypted = crypted.convertToHex();
          }
          out +=  'CT=' + crypted.convertToHex() + '<BR><BR>';
          key = twofish.pidcrypt.xOr_Array(key.convertFromHex().toByteArray(), crypted.toByteArray());
          key = twofish.pidcrypt.byteArray2String(key);
          key = key.convertToHex();
          //CV0 = iv = crypted
          //PT0 = lastCrypted
        }
        document.getElementById('report').innerHTML = out;
      break;
    case 'createKeyAndIv':
        result = twofish.cbc.createKeyAndIv({password:password, salt: '12345678', bits: bits});
        ok = (result.key == key && iv == result.iv);
      break;
    case 'encryptRaw':
    case 'decryptRaw':
        var plainRaw = plain.toByteArray();
        twofish.init(password, {salt: '12345678', bits: bits});
        crypted = twofish.encryptRaw(plainRaw);
        result = twofish.decryptRaw(crypted.toByteArray());
        ok = (plain == result);
      break;
    case 'encrypt':
    case 'decrypt':
        twofish.initByValues(plain, key, iv);
        crypted = twofish.encrypt();
        twofish.initByValues(crypted, key, iv);
        result = twofish.decrypt();
        ok = (plain == result);
      break;
    case 'encryptText':
        crypted = twofish.encryptText(plain, password, options);
        result = twofish.decryptText(crypted, password, options);
        ok = (plain == result);
      break;
    case 'decryptText':
        result = twofish.decryptText(crypted, password, options);
        ok = (plain == result);
      break;
  }
  if(ok)
    passed(testFunction);
  else
    document.getElementById('report').innerHTML += '<P><h4>' + testFunction + '</H4>' + twofish.pidcrypt.getAllMessages({lf:'<BR>'}) + '</P>';
}

function testAll(){
//  compute('init');
//  compute('initEncrypt');
//  compute('initDecrypt');
//  compute('initByValues');
  compute('knownAnswer');
//  compute('createKeyAndIv');
//  compute('encryptRaw');
//  compute('encrypt');
//  compute('encryptText');
//  compute('decryptRaw');
//  compute('decrypt');
//  compute('decryptText');

}
</SCRIPT>
</HEAD>
<BODY ONLOAD="testAll();">

<H2><A HREF="?page=aes-cbc">Twofish-CBC</A> En-/Decryption test</H2>
Please visit  <a href="http://www.pidder.com/pidcrypt">pidCrypt Home</a> for actual online demo and latest version!
<UL>
  <LI>init: <span ID="init" style="color:#FF0000">failed</span></LI>
  <LI>initEncrypt: <span ID="initEncrypt" style="color:#FF0000">failed</span></LI>
  <LI>initDecrypt: <span ID="initDecrypt" style="color:#FF0000">failed</span></LI>
  <LI>initByValues: <span ID="initByValues" style="color:#FF0000">failed</span></LI>
  <LI>knownAnswer: <span ID="knownAnswer" style="color:#FF0000">failed</span></LI>
  <LI>createKeyAndIv: <span ID="createKeyAndIv" style="color:#FF0000">failed</span></LI>
  <LI>encryptRaw: <span ID="encryptRaw" style="color:#FF0000">failed</span></LI>
  <LI>encrypt: <span ID="encrypt" style="color:#FF0000">failed</span></LI>
  <LI>encryptText: <span ID="encryptText" style="color:#FF0000">failed</span></LI>
  <LI>decryptRaw: <span ID="decryptRaw" style="color:#FF0000">failed</span></LI>
  <LI>decrypt: <span ID="decrypt" style="color:#FF0000">failed</span></LI>
  <LI>decryptText: <span ID="decryptText" style="color:#FF0000">failed</span></LI>
</UL>
<H3>Report</H3>
<DIV id="report"></DIV>
</BODY>
</HTML>

